# Migration to ONNX

### Why?

A range of models were generated using Scikit-learn 0.20.2 and then pickled. Pickled models require the same library versions.

Unfortunately using an M1 Mac it is apparently no longer possible to install sklearn versions before v0.23 via `conda`

ONNX is a format which should be resilent to specific library version changes, meaning that a production environment serving these models does not need to be pegged to specific older library versions.

### Process

Some models were unable to be ported across as there were API changes between sklearn v0.20.2 and v0.23.2

The original models are in the `models/original` folder.

Additionally on inspection the following appear to be intermediary stages (and not fitted models):

- PCA_model.sav
- RFE_model.sav

Due to API changes with sklearn `SVN_model.sav` is not able to be converted.

The `conda` environment was created with this Python version and these package versions:

```
conda create --name onnx-scikit-conversion python=3.8 scikit-learn==0.23.2 scipy==1.7.1 numpy==1.23.0 skl2onnx
```

```python
import numpy as np
import pickle
from skl2onnx import to_onnx

# dummy output generated by Parselmouth running the `MLTRNL.praat` script and filtered down to the features used
input = np.array([[0.606, 11.264, 11.26, 4.18552, 0.884384, 97.524164, 29.376381, 391.192436, 80.360621, 0.454545, 2.098873, 0.798608, 8]])

for model in ['CART', 'ETC', 'KNN', 'LDA', 'LR', 'NB']:
  m = pickle.load(open(f"{model}_model.sav", 'rb'))
  onx = to_onnx(m, input)
  with open(f"{model}.onnx", "wb") as f:
    f.write(onx.SerializeToString())

```

### Notes on the models

Using Graphviz, the `CART_model` decision tree has been visualised in [this PDF](models/original/cart_model.pdf).
In viewing this there is an indication that the training data may be inbalanced between the different classes.

The available classes are:

['a', 'a1', 'a2', 'b1', 'b2', 'c']
